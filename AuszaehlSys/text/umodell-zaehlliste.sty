\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{umodell-zaehlliste}[2004/01/26 Definitionen fuer die 
                                     Unabhaengigen Wahlen, Kristof]

\RequirePackage[latin1]{inputenc}
\RequirePackage[ngerman]{babel}
\RequirePackage{a4ultra}
\RequirePackage{denselist}
\RequirePackage{store}
\RequirePackage{keyval}
\RequirePackage{lscape}

\parindent=0pt
\pagestyle{myheadings}

\newcommand{\piwrite}[2]{%
  \begingroup%
  \let\protect\@unexpandable@protect%
  \edef\tmp{\immediate\write#1{#2}}%
  \tmp%
  \endgroup%
}

\define@key{election}{Election}{\gdef\election@Election{#1}}
\define@key{election}{CandidateVotes}{\gdef\election@CandidateVotes{#1}}
\define@key{election}{MaxCumulate}{\gdef\election@MaxCumulate{#1}}
\define@key{election}{CrossList}[]{}
\define@key{election}{NoCrossList}[]{}

\newcommand{\hr}[1]{\rule{#1}{0.4pt}}

\newcount\partycnt
\newwrite\umzl@write@party
\newwrite\umzl@write@cand

\newenvironment{election}[1]{
  \newpage
  \sloppy
  \gdef\election@Election{}%
  \gdef\election@CandidateVotes{1}%
  \gdef\election@MaxCumulate{1}%
  \setkeys{election}{#1}%

  \markright{\bfseries Zählliste: \election@Election\ --
             Urne:~\protect\hr{3cm}}
  \setcounter{page}{1}
  \global\partycnt=0

  \immediate\openout\umzl@write@party\jobname.uzp%
  \immediate\openout\umzl@write@cand\jobname.uzc%
}{
  \immediate\closeout\umzl@write@party%
  \immediate\closeout\umzl@write@cand%

  \hrule height 0pt
  \begin{center}
    \bfseries
    \Huge
    Zählliste
    \bigskip

    \LARGE
    \election@Election
    \bigskip

    Urne:~\hr{5cm}
    \smallskip

    \normalsize\mdseries
    Bitte auch oben auf allen Seiten eintragen!
    \bigskip

  \end{center}
  \setcounter{section}{0}

  \section{Stimmzettel}

  \subsection{Stimmzettel laut Urnenbuch}

  Zählt die Eintragungen im Urnenbuch. Achtet bei Urnen mit verschiedenen
  Wahlen (z.B.\ mehrere Fachschaften) darauf, nur die zur o.g.\ Wahl zu
  zählen.

  {\bigskip\large Anzahl der Stimmzettel laut Urnenbuch:~\hr{3cm}}

  \subsection{Stimmzettel in der Urne}

%  Öffnet nun die Urne, sortiert die Stimmzettel nach Wahlen und zählt sie
%  für jede Wahl getrennt durch. 
  Zählt nun die Stimmzettel für diese Wahl.
  
  {\bigskip\large Anzahl der Stimmzettel in der Urne:~\hr{3cm}}

  \subsection{Erläuterung der Abweichungen}

  Falls die Stimmzettelzahlen in der Urne und im Urnenbuch voneinander
  abweichen, bitte hier erläutern: \\ \footnotesize{Bei Fachschaftswahlen müssen
  Abweichungen nicht erläutert werden, wenn alle FS-Zettel zusammen die gleiche
  Summe wie im Urnenbuch ergeben.}

  \vspace{3cm}

  \subsection{Ungültige Stimmzettel}

  Sortiert nun die ungültigen Stimmzettel aus und zählt sie durch. Ungültig
  sind Stimmzettel (§11(6) Wahlordnung),
  \begin{enumerate}
  \item die in Inhalt, Form und Farbe von den bereitgestellten abweichen,
  \item die ganz durchgestrichen oder ganz durchgerissen sind,
  \item die mit Bemerkungen versehen sind, ein auf die Person des Wählenden
    hinweisendes Merkmal oder einen Vorbehalt enthalten,
  \item aus dem sich der Wille der Wählerin oder des Wählers nicht
    zweifelsfrei ergibt,
  \item bei den Fachschaftsvorstandswahlen, wenn mehr Stimmen als
    gemäß §1(7) zugelassen sind [hier: \election@CandidateVotes],
    abgegeben wurden oder wenn mehr als zwei Stimmen auf eine
    Kandidatin oder einen Kandidaten vereinigt wurden.
  \end{enumerate}

  {\bigskip\large Anzahl der ungültigen Stimmzettel:~\hr{3cm}}

  \ifnum\partycnt>1

  \section{Listenstimmen}

  \subsection{Ungültige Listenstimmen}

  Sortiert nun von den gültigen Stimmzetteln die ungültigen
  Listenstimmen aus und zählt sie. Ungültig sind Stimmen (§11(7)
  Wahlordnung),
  \begin{enumerate}
  \item bei der SP-Wahl, wenn mehr als eine Liste angekreuzt ist,
  \item\relax [\ldots]
  \item bei denen nicht erkennbar ist, für welche Kandidatinnen oder
    Kandidaten sie abgegeben wurden,
  \item wenn gegenüber der oder dem gewählten eine Verwahrung oder ein
    Vorbehalt beigefügt ist,
  \item welche für Personen abgegeben sind, die auf keinem Wahlvorschlag
    aufgeführt sind
  \end{enumerate}

  {\bigskip\large Anzahl der ungültigen Listenstimmen:~\hr{3cm}}

  \subsection{Enthaltungen bei den Listenstimmen}

  Sortiert nun von den gültigen Listenstimmen die Enthaltungen aus und
  zählt sie. (§11(9): Nicht abgegebene [\ldots] Listenstimmen werden als
  Enthaltungen gezählt.)

  {\bigskip\large Anzahl der Enthaltungen bei den Listenstimmen:~\hr{3cm}}

  \subsection{Auszählung der Listenstimmen}

  Zählt nun mit der Strichliste im Anhang die Listenstimmen aus.

  Werft danach alle gültigen Stimmzettel wieder zusammen.
  \fi

  \section{Kandidierendenstimmen}

  \subsection{Ungültige Kandidierendenstimmen}
  Sortiert von den gültigen Stimmzetteln die ungültigen
  Kandidierendenstimmen aus. Ungültig sind Stimmen (§11(7) Wahlordnung),
  \begin{enumerate}
  \item\relax [\ldots]
  \item bei der SP-Wahl, wenn mehr als fünf Stimmen für Kandidatinnen
   und Kandidaten abgegeben wurden. Die Listenstimme bleibt dabei
   gültig.
  \item bei denen nicht erkennbar ist, für welche Kandidatinnen oder
    Kandidaten sie abgegeben wurden,
  \item wenn gegenüber der oder dem gewählten eine Verwahrung oder ein
    Vorbehalt beigefügt ist,
  \item welche für Personen abgegeben sind, die auf keinem Wahlvorschlag
    aufgeführt sind
  \end{enumerate}

  {\bigskip\large Anzahl der ungültigen Kandidierendenstimmen:~\hr{3cm}}

  \ifnum\election@CandidateVotes=1

  \subsection{Enthaltungen bei den Kandidierendenstimmen}
  Zählt nun die Enthaltungen bei den Kandidierendenstimmen.

  {\bigskip\large Enthaltungen bei den Kandidierendenstimmen:~\hr{3cm}}

  \fi

  \subsection{Auszählung der Kandidierendenstimmen}

  Zählt nun mit der folgenden Strichliste die Kandidierendenstimmen aus:
  \bigskip

  \input{\jobname.uzc}
  \bigskip

  \section{Unterschriften}
  
  Bitte unterschreiben und Name in Druckbuchstaben dahintersetzen:

  \vskip1cm
  \underbox{Schriftführer}\hrulefill\hrulefill
  \hfill
  \hrulefill\hrulefill
  \hfill
  \hrulefill\hrulefill

  \vskip1cm
  {\large Karlsruhe, den~\hr{3cm}}

  \ifnum\partycnt>1
  \begin{landscape}
    \subsection*{Strichliste für die Listenstimmen}
    \headrow{\bf Liste}{\bf Summe}
    \input{\jobname.uzp}
  \end{landscape}
  \fi
}

\newcommand{\underbox}[1]{%
  \makebox[0pt][l]{\raisebox{-\baselineskip}{#1}}%
}

\newenvironment{party}[3]{
  \global\advance\partycnt by 1
  \piwrite\umzl@write@party{\string\umzlparty{#1}{#2}}
  \piwrite\umzl@write@cand{\string\umzlcandparty{#1}{#2}}
}

\newcommand{\candidate}[3]{
  \piwrite\umzl@write@cand{\string\umzlcand{#1}{#2}}
}

\newcommand{\basicrow}[3]{
  \nointerlineskip%
  \parbox{\hsize}{%
    \hrule%
    \vrule%
    \hskip3pt
    \parbox[c][#1][c]{3cm}{\raggedright #2}%
    \hskip3pt
    \vrule%
    \hfill%
    \vrule%
    \hskip3pt%
    \parbox{1.6cm}{\raggedleft #3~}%
    \hskip3pt
    \vrule%
    \hrule%
    \vskip-.4pt
  }\par
}

\newcommand{\countrow}[1]{\basicrow{1cm}{#1}{}}
\newcommand{\headrow}[2]{\basicrow{1.5\baselineskip}{\large#1}{\large#2}}

\newcommand{\umzlparty}[2]{\countrow{#1}}

\newcommand{\umzlcand}[2]{\countrow{#1}}

\newcommand{\umzlcandparty}[2]{%
  \ifnum\partycnt>1\filbreak\subsubsection*{Liste: #1}\fi
  \headrow{\bf Kandidat}{\bf Summe}
}
